# Data Model: Power BI Best Practices Analyzer & AI Auto-Fix Web App

**Phase**: 1 | **Date**: 2026-02-20

## Prisma Schema

```prisma
datasource db {
  provider = "sqlite"
}

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

model AnalysisRun {
  id            String    @id @default(cuid())
  modelName     String
  serverAddress String
  databaseName  String
  startedAt     DateTime  @default(now())
  completedAt   DateTime?
  status        String    @default("RUNNING") // RUNNING | COMPLETED | FAILED
  errorCount    Int       @default(0)
  warningCount  Int       @default(0)
  infoCount     Int       @default(0)
  findings      Finding[]
}

model Finding {
  id              String       @id @default(cuid())
  analysisRunId   String
  analysisRun     AnalysisRun  @relation(fields: [analysisRunId], references: [id], onDelete: Cascade)
  ruleId          String       // Maps to BPA rule ID (e.g., "AVOID_FLOATING_POINT_DATA_TYPES")
  ruleName        String       // Display name from BPA rule
  category        String       // Performance, DAX Expressions, Error Prevention, Maintenance, Naming Conventions, Formatting
  severity        Int          // 1=Info, 2=Warning, 3=Error
  description     String
  affectedObject  String       // e.g., "'Sales'[Amount]" or "Sales" (table/column/measure path)
  objectType      String       // Table, Column, Measure, Relationship, Model, Partition, etc.
  fixStatus       String       @default("UNFIXED") // UNFIXED | IN_PROGRESS | FIXED | FAILED
  fixSummary      String?      // Human-readable description of what was changed
  hasAutoFix      Boolean      @default(false) // True if BPA rule has FixExpression
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  fixSession      FixSession?
}

model FixSession {
  id          String         @id @default(cuid())
  findingId   String         @unique
  finding     Finding        @relation(fields: [findingId], references: [id], onDelete: Cascade)
  agentSessionId String?     // Copilot SDK session ID for resumption
  status      String         @default("PENDING") // PENDING | RUNNING | COMPLETED | FAILED
  startedAt   DateTime       @default(now())
  completedAt DateTime?
  steps       FixSessionStep[]
}

model FixSessionStep {
  id           String     @id @default(cuid())
  fixSessionId String
  fixSession   FixSession @relation(fields: [fixSessionId], references: [id], onDelete: Cascade)
  stepNumber   Int
  eventType    String     // reasoning | tool_call | tool_result | message | error
  content      String     // JSON-encoded event data
  timestamp    DateTime   @default(now())
}

model DaxQuery {
  id            String   @id @default(cuid())
  queryText     String
  naturalLanguage String? // Original NL prompt if generated by AI
  status        String   @default("PENDING") // PENDING | RUNNING | COMPLETED | FAILED
  resultData    String?  // JSON-encoded result rows
  rowCount      Int?
  executionTimeMs Int?
  errorMessage  String?
  createdAt     DateTime @default(now())
}
```

## Entity Relationship Diagram

```
┌─────────────────┐       ┌──────────────────┐       ┌──────────────────┐
│  AnalysisRun    │ 1───* │    Finding        │ 1───? │   FixSession     │
├─────────────────┤       ├──────────────────┤       ├──────────────────┤
│ id              │       │ id               │       │ id               │
│ modelName       │       │ analysisRunId    │───┐   │ findingId        │───┐
│ serverAddress   │       │ ruleId           │   │   │ agentSessionId   │   │
│ databaseName    │       │ ruleName         │   │   │ status           │   │
│ startedAt       │       │ category         │   │   │ startedAt        │   │
│ completedAt     │       │ severity         │   │   │ completedAt      │   │
│ status          │       │ description      │   │   └──────────────────┘   │
│ errorCount      │       │ affectedObject   │   │          │               │
│ warningCount    │       │ objectType       │   │          │ 1             │
│ infoCount       │       │ fixStatus        │   │          │               │
└─────────────────┘       │ fixSummary       │   │          * ──────────────┘
                          │ hasAutoFix       │   │   ┌──────────────────┐
                          │ createdAt        │   │   │ FixSessionStep   │
                          │ updatedAt        │   │   ├──────────────────┤
                          └──────────────────┘   │   │ id               │
                                                 │   │ fixSessionId     │
                          ┌──────────────────┐   │   │ stepNumber       │
                          │   DaxQuery       │   │   │ eventType        │
                          ├──────────────────┤   │   │ content          │
                          │ id               │   │   │ timestamp        │
                          │ queryText        │   │   └──────────────────┘
                          │ naturalLanguage  │   │
                          │ status           │   └── FK: analysisRunId → AnalysisRun.id
                          │ resultData       │
                          │ rowCount         │
                          │ executionTimeMs  │
                          │ errorMessage     │
                          │ createdAt        │
                          └──────────────────┘
```

## Entity Descriptions

### AnalysisRun
Represents a single execution of the best practices analyzer against a connected Power BI Semantic Model. Tracks summary counts for quick overview display (FR-005).

**Lifecycle**: `RUNNING` → `COMPLETED` | `FAILED`

### Finding
An individual best-practice violation detected during an analysis run. Links to the BPA rule that triggered it and tracks fix status through the remediation lifecycle.

**Lifecycle**: `UNFIXED` → `IN_PROGRESS` → `FIXED` | `FAILED`

**Key fields**:
- `ruleId`: Maps back to the BPA rules JSON for full rule context
- `hasAutoFix`: Indicates whether the rule has a deterministic `FixExpression` (no AI needed)
- `affectedObject`: Human-readable path to the model object (e.g., `'Sales'[Amount]`)

### FixSession
Records an AI agent's attempt to fix a specific finding. Stores the Copilot SDK session ID for potential session resumption and inspection (FR-010).

**Lifecycle**: `PENDING` → `RUNNING` → `COMPLETED` | `FAILED`

### FixSessionStep
Individual step within an AI fix session. Captures reasoning, tool calls, results, and messages in chronological order for the agent session inspector.

**Event types**:
- `reasoning`: AI reasoning/analysis step
- `tool_call`: MCP tool invocation (e.g., `column_operations.Update`)
- `tool_result`: Result of an MCP tool call
- `message`: Assistant message/explanation
- `error`: Error encountered during fix

### DaxQuery
A DAX query entered or generated by the user. Supports both manual entry and AI-generated queries from natural language. Results are stored as JSON for display in the results table.

**Lifecycle**: `PENDING` → `RUNNING` → `COMPLETED` | `FAILED`

## Validation Rules

| Entity | Field | Rule |
|--------|-------|------|
| AnalysisRun | status | Must be one of: RUNNING, COMPLETED, FAILED |
| Finding | severity | Must be 1, 2, or 3 |
| Finding | fixStatus | Must be one of: UNFIXED, IN_PROGRESS, FIXED, FAILED |
| Finding | category | Must be one of: Performance, DAX Expressions, Error Prevention, Maintenance, Naming Conventions, Formatting |
| FixSession | status | Must be one of: PENDING, RUNNING, COMPLETED, FAILED |
| FixSessionStep | eventType | Must be one of: reasoning, tool_call, tool_result, message, error |
| FixSessionStep | stepNumber | Must be >= 1, unique within a session |
| DaxQuery | status | Must be one of: PENDING, RUNNING, COMPLETED, FAILED |
| DaxQuery | queryText | Must not be empty |

## State Transitions

### Finding Fix Flow
```
UNFIXED ──[user triggers fix]──→ IN_PROGRESS ──[fix succeeds]──→ FIXED
                                              ──[fix fails]────→ FAILED
FAILED  ──[user retries fix]───→ IN_PROGRESS
```

### Analysis Rerun
When a rerun is triggered, a new `AnalysisRun` is created. Previously `FIXED` findings that no longer appear in the new run are confirmed resolved. Previously `FIXED` findings that still appear indicate the fix was insufficient.
